#cloud-config

hostname: laravel-app
fqdn: laravel-app.local

# Posodobitev sistema
package_update: true
package_upgrade: true

# Namestitev paketov
packages:
  - nginx
  - mysql-server
  - php-fpm
  - php-mysql
  - php-mbstring
  - php-xml
  - php-bcmath
  - php-zip
  - php-curl
  - php-cli
  - php-gd
  - unzip
  - git
  - curl
  - ca-certificates
  - openssl

# Datoteke
write_files:
  # MySQL init
  - path: /tmp/mysql-init.sql
    permissions: '0600'
    content: |
      CREATE DATABASE IF NOT EXISTS ucilnice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
      CREATE USER IF NOT EXISTS 'ucilnica'@'localhost' IDENTIFIED BY 'ucilnica';
      GRANT ALL PRIVILEGES ON ucilnice.* TO 'ucilnica'@'localhost';
      FLUSH PRIVILEGES;

  # Laravel .env template
  - path: /tmp/laravel.env
    permissions: '0644'
    content: |
      APP_NAME=Ucilnice
      APP_ENV=production
      APP_KEY=
      APP_DEBUG=false
      APP_URL=https://st.stipek.si
      
      DB_CONNECTION=mysql
      DB_HOST=127.0.0.1
      DB_PORT=3306
      DB_DATABASE=ucilnice
      DB_USERNAME=ucilnica
      DB_PASSWORD=ucilnica
      
      CACHE_DRIVER=file
      SESSION_DRIVER=file
      QUEUE_CONNECTION=sync

  # Nginx HTTPS config
  - path: /tmp/nginx-laravel.conf
    permissions: '0644'
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          return 301 https://$host$request_uri;
      }

      server {
          listen 443 ssl http2 default_server;
          listen [::]:443 ssl http2 default_server;

          server_name st.stipek.si localhost _;
          root /var/www/ucilnice/public;
          index index.php index.html;

          ssl_certificate /etc/nginx/ssl/laravel.crt;
          ssl_certificate_key /etc/nginx/ssl/laravel.key;

          # SSL Security Settings
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;
          ssl_prefer_server_ciphers on;

          # Security Headers
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-XSS-Protection "1; mode=block" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Referrer-Policy "no-referrer-when-downgrade" always;
          # CSP dovoli inline scripts in styles za Laravel/Vite
          add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;

          # Gzip Compression
          gzip on;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_proxied expired no-cache no-store private auth;
          gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss;

          # Handle Laravel Routes
          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          # PHP Processing
          location ~ .php$ {
              fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
              fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
              include fastcgi_params;
              fastcgi_index index.php;
              fastcgi_hide_header X-Powered-By;
          }

          # Static Files Caching
          location ~* .(jpg|jpeg|png|gif|ico|css|js)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
          }

          # Security: Deny access to hidden files
          #location ~ /. {
          #    deny all;
          #}

          # Security: Deny access to sensitive files
          location ~ /(.env|.git|composer.(json|lock)|package.json) {
              deny all;
          }

          # Favicon and robots.txt
          location = /favicon.ico { access_log off; log_not_found off; }
          location = /robots.txt  { access_log off; log_not_found off; }
      }

  # Setup script
  - path: /tmp/setup-laravel.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      if [ -f /tmp/nginx-laravel.conf ]; then
        echo "[*] Nastavitev Nginx konfiguracije..."
        mv /tmp/nginx-laravel.conf /etc/nginx/sites-available/laravel
        ln -sf /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/laravel
      fi
      
      # Composer install
      if ! command -v composer >/dev/null 2>&1; then
        echo "[*] Namestitev Composer..."
        curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php
        php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
        rm /tmp/composer-setup.php
      fi
      
      
      # SSL certifikat
      echo "[*] Generiranje SSL certifikata..."
      mkdir -p /etc/nginx/ssl
      
      # Če obstaja custom certifikat, uporabi tega
      if [ -f /opt/ssl/laravel.crt ] && [ -f /opt/ssl/laravel.key ]; then
        echo "[*] Uporabljam custom SSL certifikat..."
        cp /opt/ssl/laravel.crt /etc/nginx/ssl/
        cp /opt/ssl/laravel.key /etc/nginx/ssl/
        chmod 600 /etc/nginx/ssl/laravel.key
        chmod 644 /etc/nginx/ssl/laravel.crt
      fi
      
      # Preveri Laravel projekt
      if [ ! -d /opt/ucilnice ]; then
        echo "[!] Laravel projekt ne obstaja v /opt/ucilnice"
        echo "[*] Za mountanje uporabi:"
        echo "    incus file push -r ucilnice/ laravel-app/opt/"
        exit 0
      fi
      
      echo "[*] Kopiranje Laravel projekta..."
      rm -rf /var/www/ucilnice
      cp -r /opt/ucilnice /var/www/
      cd /var/www/ucilnice
      
      # .env setup
      if [ ! -f .env ]; then
        if [ -f .env.example ]; then
          cp .env.example .env
        else
          cp /tmp/laravel.env .env
        fi
        sed -i 's|DB_DATABASE=.*|DB_DATABASE=ucilnice|' .env
        sed -i 's|DB_USERNAME=.*|DB_USERNAME=ucilnica|' .env
        sed -i 's|DB_PASSWORD=.*|DB_PASSWORD=ucilnica|' .env
      fi
      
      # Composer dependencies
      echo "[*] Namestitev dependencies..."
      composer install --no-interaction --optimize-autoloader --no-dev
      
      # NPM build
      #if [ -f package.json ]; then
      #  echo "[*] Build frontend assets..."
      #  npm install
      #  npm run build
      #fi
      
      # Laravel setup
      php artisan key:generate --force
      
      # Database
      if [ -f /opt/db.sql ]; then
        echo "[*] Uvažam SQL dump..."
        mysql ucilnice < /opt/db.sql
      else
        echo "[*] Poženem migrations..."
        php artisan migrate --force
      fi
      
      # Cache
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
      
      # Permissions
      chown -R www-data:www-data /var/www/ucilnice
      chmod -R 755 /var/www/ucilnice
      chmod -R 775 /var/www/ucilnice/storage
      chmod -R 775 /var/www/ucilnice/bootstrap/cache
      
      echo "Laravel aplikacija je pripravljena."

# Ukazi ob zagonu
runcmd:
  # MySQL setup
  - systemctl start mysql
  - mysql < /tmp/mysql-init.sql
  - rm /tmp/mysql-init.sql
  
  # Nginx setup
  - rm -f /etc/nginx/sites-enabled/default
  
  # Omogocimo services
  - systemctl enable nginx mysql
  - systemctl start nginx
  
  # Laravel setup
  - bash /tmp/setup-laravel.sh || true
  
  # Final nginx enable
  - ln -sf /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/
  - rm /etc/nginx/sites-enabled/default || true
  - nginx -t && systemctl restart nginx || true
  
  # Status
  - |
    IP=$(hostname -I | awk '{print $1}')
    echo ""
    echo "======================================"
    echo " Laravel HTTPS server pripravljen!"
    echo "======================================"
    echo "HTTP:  http://$IP"
    echo "HTTPS: https://$IP"
    echo "======================================"

final_message: |
  Cloud-init setup končan!
  Laravel HTTPS server je pripravljen.